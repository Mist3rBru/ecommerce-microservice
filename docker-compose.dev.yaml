version: '3'

services:
  kafka:
    environment:
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092

  product:
    container_name: product-api
    image: product
    build:
      context: .
      dockerfile: Dockerfile
      target: product
    restart: always
    environment:
      - APP_PORT=3002
      - KAFKA_ID=product-api
      - KAFKA_BROKER=kafka:9092
      - KAFKA_RETRY_TIME=${KAFKA_RETRY_TIME}
      - KAFKA_RETRY_TIMES=${KAFKA_RETRY_TIMES}
    ports:
      - '3002:3002'
    command: bash -c "npx tsx watch product/server.ts"
    depends_on:
      - kafka
    networks:
      - app-net

  customer:
    container_name: customer-api
    image: customer
    build:
      context: .
      dockerfile: Dockerfile
      target: customer
    restart: always
    environment:
      - APP_PORT=3001
      - KAFKA_ID=customer-api
      - KAFKA_BROKER=kafka:9092
      - KAFKA_RETRY_TIME=${KAFKA_RETRY_TIME}
      - KAFKA_RETRY_TIMES=${KAFKA_RETRY_TIMES}
    ports:
      - '3001:3001'
    command: bash -c "npx tsx watch customer/server.ts"
    depends_on:
      - kafka
    networks:
      - app-net

  gateway:
    container_name: gateway-api
    image: gateway
    build:
      context: .
      dockerfile: Dockerfile
      target: gateway
    restart: always
    environment:
      - APP_PORT=3000
      - GATEWAY_URL=${GATEWAY_URL}
      - CUSTOMER_URL=http://customer:3001
      - PRODUCT_URL=http://product:3002
    ports:
      - '3000:3000'
    command: bash -c "npx tsx watch gateway/server.ts"
    depends_on:
      - customer
      - product
    networks:
      - app-net
